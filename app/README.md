# ECG Processor Project Solution

## Overview

This project is designed to facilitate the management of Electrocardiogram (ECG) data through a secure and efficient web application. Leveraging modern technologies such as FastAPI, Docker, pytest, SQLAlchemy, Alembic, and Numpy, the application ensures a high-performance and scalable solution for ECG data processing.

## Prerequisites

Before setting up the project, ensure you have the following installed:

- **Docker**: For containerization and easy management of application components.
- **Docker Compose**: For defining and running multi-container Docker applications.

## Main Technologies

- **FastAPI**: Offers a high-performance framework for building APIs, complete with automatic Swagger documentation.
- **pytest**: Provides a robust framework for testing the application, ensuring reliability and stability.
- **SQLAlchemy & Alembic**: Used for ORM and database migration management, respectively, facilitating database operations.
- **Numpy**: Utilized for performance-critical operations on large datasets, particularly useful in processing ECG data.

### Background Tasks for ECG Analysis

To enhance the application's performance and user experience, we utilize background tasks for the analysis of ECG records. This approach ensures that the event loop is not blocked by the processing of ECG data, allowing the API to remain responsive and not make the client wait for the analysis to complete. When an ECG record is created, the analysis task is scheduled to run in the background, enabling immediate acknowledgment of the record creation to the user while the processing occurs asynchronously.

This method leverages FastAPI's capability to manage background tasks efficiently, ensuring that our application can handle high volumes of ECG data without compromising on speed or responsiveness.

## Docker Compose and Setup

The application uses Docker Compose to orchestrate its services, implementing a "wait-for-it" strategy to ensure the database is fully operational before starting the API service. This guarantees smooth initialization and service reliability.

## Usage

To get the application up and running:

```bash
docker-compose up --build --force-recreate
```

This command builds the necessary Docker images, creates containers, and starts the services. The application will be accessible on port 8000.

## Endpoints

### Login

- **Endpoint**: `api/v1/login`
- **Method**: POST
- **Description**: Authenticates users and generates a JWT access token.

### Create User

- **Endpoint**: `api/v1/users`
- **Method**: POST
- **Description**: Allows admin users to create ECG Operator users.

### Create ECG Record

- **Endpoint**: `api/v1/ecgs`
- **Method**: POST
- **Description**: Enables authorized users to create ECG records and schedules them for processing.

### Retrieve ECG Record

- **Endpoint**: `api/v1/ecgs/{ecg_id}`
- **Method**: GET
- **Description**: Allows users to retrieve ECG records by their ID.

### Documentation and API Exploration

The application's API documentation is available at the `/docs` endpoint. This documentation is automatically generated by FastAPI and provides an interactive interface for exploring the available API endpoints, their expected parameters, and response models. Users can also try out the API directly from this interface, making it a valuable tool for developers and users alike to understand and interact with the application.

To access the documentation, simply navigate to `http://localhost:8000/docs` in your web browser after starting the application. Here, you'll find detailed information about each endpoint, including how to authenticate and execute requests, making it easy to get started with using the application's capabilities.



### Interacting with the API

1. **Login**: Use the `/login` endpoint with admin credentials to obtain a JWT token.
2. **Create ECG Operator User**: With the admin token, use the `/users` endpoint to create ECG operator users.
3. **Create an ECG Record**: Authorized users can create an ECG record by sending a POST request to the `/ecgs` endpoint with the necessary ECG data. This endpoint requires authentication and appropriate permissions (`ecg:create`). Upon successful creation, the system schedules the ECG data for processing and returns a confirmation message along with the ECG record's ID.
4. **Retrieve ECG Analysis**: Once an ECG record has been processed, users can retrieve the analysis by sending a GET request to `/ecgs/{ecg_id}`, where `{ecg_id}` is the ID of the ECG record. This request requires user authentication and permissions (`ecg:read`). If the ECG has been processed, the endpoint returns the ECG analysis data; otherwise, it may return a status indicating that the analysis is not yet available.

Note: For simplicity, an admin user is pre-created, and user groups are predefined. However, in a production environment, secure management of credentials and permissions is recommended.

## Testing

The project includes comprehensive tests to ensure the functionality and reliability of the API. These tests are built using `pytest`, allowing for automated testing of the application's endpoints, integration logic, and data processing capabilities.

### Running Tests

To run the tests, we utilize a separate Docker Compose configuration tailored for the testing environment. This ensures that testing does not interfere with the development or production environments and provides a clean, isolated setup for accurate test results.

Use the following command to execute the test suite:

```bash
docker-compose -f docker-compose-test.yml build
```
and then 

```bash
docker-compose -f docker-compose-test.yml run --rm test-api pytest --disable-pytest-warnings && docker-compose -f docker-compose-test.yml down
```

This command performs the following actions:

1. **Builds and starts the test environment**: It uses `docker-compose-test.yml`, which should be configured to set up the necessary services for testing, such as the application service and a test database.
2. **Runs the tests**: The `pytest` command is executed within the test service container (`test-api`). The `--disable-pytest-warnings` option is used to suppress warnings for cleaner output.
3. **Cleans up**: After testing, `docker-compose -f docker-compose-test.yml down` is called to stop and remove the containers and networks created for the test environment.

Note: The testing database is automatically teared down after running the tests

## Improvements

- **Asynchronous Database Sessions**: Implementing async sessions could further enhance performance by preventing blocking of the event loop during database interactions.
- **Scaling**: Increase the number of API workers as needed for load management.
- **Security**: Transition to HTTPS and use certificates (e.g., via Nginx) to secure data transmission.


